{% extends 'demo/base.html' %}
{% load static %}

{% block title %}ç”¨æˆ·æ³¨å†Œ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/register.css' %}"/>
{% endblock %}

{% block content %}
<section class="auth-wrapper auth-wrapper--register">
    <div class="auth-grid">
        <div class="auth-card" id="registerFormContainer">
        <div class="auth-card__header">
            <h2>åˆ›å»ºè´¦æˆ·</h2>
            <p>å¡«å†™ä»¥ä¸‹ä¿¡æ¯ä»¥åŠ å…¥ Django Hub</p>
        </div>

        {% if messages %}
        <div class="auth-alert auth-alert--error" role="alert">
            <i class="material-icons" aria-hidden="true">error_outline</i>
            <div>
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <form method="post" class="auth-form" id="registerForm" novalidate>
            {% csrf_token %}

            <div class="form-field">
                <input id="username" name="username" type="text" placeholder=" " required autocomplete="username">
                <label for="username">ç”¨æˆ·å</label>
                <small class="form-tip" id="usernameTip">æ”¯æŒ 3-20 ä¸ªå­—ç¬¦ï¼Œå¯åŒ…å«å­—æ¯ã€æ•°å­—ä¸ä¸‹åˆ’çº¿</small>
            </div>

            <div class="form-field form-field--with-meter">
                <input id="password1" name="password1" type="password" placeholder=" " required autocomplete="new-password">
                <label for="password1">å¯†ç </label>
                <div class="form-meter" aria-hidden="true">
                    <div class="form-meter__bar" id="passwordStrengthBar"></div>
                </div>
                <small class="form-tip" id="passwordStrengthText">è¯·è¾“å…¥è‡³å°‘ 8 ä½çš„å®‰å…¨å¯†ç </small>
            </div>

            <div class="form-field">
                <input id="password2" name="password2" type="password" placeholder=" " required autocomplete="new-password">
                <label for="password2">ç¡®è®¤å¯†ç </label>
                <small class="form-tip">å†æ¬¡è¾“å…¥å¯†ç ï¼Œç¡®ä¿ä¸¤æ¬¡è¾“å…¥ä¸€è‡´</small>
            </div>

            <div class="form-extras">
                <label class="form-checkbox">
                    <input type="checkbox" id="agreement" required>
                    <span class="form-checkbox__decor" aria-hidden="true">
                        <i class="material-icons">check</i>
                    </span>
                    <span class="form-checkbox__label">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#" class="form-link">ä½¿ç”¨æ¡æ¬¾</a> ä¸ <a href="#" class="form-link">éšç§æ”¿ç­–</a></span>
                </label>
            </div>

            <button class="form-button" type="submit" id="registerSubmit">
                <span class="form-button__label">ç«‹å³æ³¨å†Œ</span>
                <i class="material-icons" aria-hidden="true">person_add</i>
            </button>
        </form>

        <div class="auth-footer">
            <span>å·²ç»æ‹¥æœ‰è´¦æˆ·ï¼Ÿ</span>
            <a href="{% url 'demo:login' %}">ç›´æ¥ç™»å½•</a>
            </div>
    </div>

        <div class="auth-hero">
            <div class="auth-hero__card">
                <div class="auth-hero__badge">ğŸš€ æ¬¢è¿åŠ å…¥</div>
                <h1 class="auth-hero__title">åˆ›å»ºä¸“å±çš„ Django Hub åä½œç©ºé—´</h1>
                <p class="auth-hero__subtitle">ä¸ºå›¢é˜Ÿæˆå‘˜è§„åˆ’è§’è‰²ã€æƒé™ä¸æµç¨‹ï¼Œä»æ³¨å†Œè¿™ä¸€åˆ»å¼€å§‹é«˜æ•ˆååŒã€‚å¼ºå¤§çš„æƒé™ç®¡ç†ç³»ç»Ÿè®©å›¢é˜Ÿåä½œæ›´å®‰å…¨ã€æ›´é«˜æ•ˆã€‚</p>
                <ul class="auth-hero__list">
                    <li><i class="material-icons">people_alt</i><span><strong>å¤šè§’è‰²åˆ†å±‚</strong> - ç²¾ç»†åŒ–çš„æƒé™è¾¹ç•Œï¼Œè®©å›¢é˜Ÿç®¡ç†æ›´æ¸…æ™°</span></li>
                    <li><i class="material-icons">rule</i><span><strong>ç­–ç•¥ç®¡æ§</strong> - ç»†ç²’åº¦çš„æƒé™ç­–ç•¥ï¼Œä¿éšœå…³é”®æ•°æ®å®‰å…¨</span></li>
                    <li><i class="material-icons">insights</i><span><strong>å®æ—¶å®¡è®¡</strong> - å®Œæ•´çš„æ“ä½œæ—¥å¿—ï¼ŒæŒæ¡æ¯ä¸€æ¬¡é‡è¦å˜æ›´</span></li>
                    <li><i class="material-icons">security</i><span><strong>å®‰å…¨å¯é </strong> - ä¼ä¸šçº§å®‰å…¨é˜²æŠ¤ï¼Œæ•°æ®åŠ å¯†ä¼ è¾“å­˜å‚¨</span></li>
                </ul>
                <div class="auth-hero__stats">
                    <div class="stat-item">
                        <div class="stat-number">99.9%</div>
                        <div class="stat-label">æœåŠ¡å¯ç”¨æ€§</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">256ä½</div>
                        <div class="stat-label">åŠ å¯†å¼ºåº¦</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">24/7</div>
                        <div class="stat-label">ç›‘æ§æ”¯æŒ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
(function () {
    const username = document.getElementById('username');
    const usernameTip = document.getElementById('usernameTip');
    const password1 = document.getElementById('password1');
    const password2 = document.getElementById('password2');
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    const registerForm = document.getElementById('registerForm');
    const submitBtn = document.getElementById('registerSubmit');
    let usernameCheckTimeout;

    function checkUsername(username) {
        clearTimeout(usernameCheckTimeout);
        usernameCheckTimeout = setTimeout(() => {
            if (username.length < 3) {
                usernameTip.textContent = 'æ”¯æŒ 3-20 ä¸ªå­—ç¬¦ï¼Œå¯åŒ…å«å­—æ¯ã€æ•°å­—ä¸ä¸‹åˆ’çº¿';
                usernameTip.style.color = 'var(--auth-text-secondary)';
                username.classList.remove('is-valid', 'is-invalid');
                return;
            }

            fetch(`{% url 'demo:check_username' %}?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        usernameTip.textContent = data.message;
                        usernameTip.style.color = '#34d399';
                        username.classList.add('is-valid');
                        username.classList.remove('is-invalid');
                    } else {
                        usernameTip.textContent = data.message;
                        usernameTip.style.color = '#f87171';
                        username.classList.add('is-invalid');
                        username.classList.remove('is-valid');
                    }
                })
                .catch(error => {
                    console.error('ç”¨æˆ·åéªŒè¯å¤±è´¥:', error);
                    usernameTip.textContent = 'éªŒè¯æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                    usernameTip.style.color = '#f59e0b';
                });
        }, 500);
    }

    function updateStrengthIndicator(value) {
        let strength = 0;
        if (value.length >= 8) strength += 25;
        if (/[A-Z]/.test(value)) strength += 25;
        if (/[0-9]/.test(value)) strength += 25;
        if (/[^A-Za-z0-9]/.test(value)) strength += 25;

        strengthBar.style.width = strength + '%';
        strengthBar.className = 'form-meter__bar';

        if (!value.length) {
            strengthText.textContent = 'è¯·è¾“å…¥è‡³å°‘ 8 ä½çš„å®‰å…¨å¯†ç ';
            return;
        }

        if (strength < 50) {
            strengthBar.classList.add('is-weak');
            strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼± â€“ å»ºè®®åŒ…å«å¤§å°å†™å­—æ¯ä¸ç¬¦å·';
        } else if (strength < 75) {
            strengthBar.classList.add('is-medium');
            strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šä¸­ â€“ å†æ·»åŠ ä¸€äº›ç¬¦å·ä¼šæ›´å®‰å…¨';
        } else {
            strengthBar.classList.add('is-strong');
            strengthText.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼º';
        }
    }

    if (username) {
        username.addEventListener('input', function () {
            checkUsername(this.value);
        });
    }

    if (password1) {
        password1.addEventListener('input', function () {
            updateStrengthIndicator(this.value);
            if (password2.value && password2.value !== this.value) {
                password2.classList.add('is-invalid');
            } else {
                password2.classList.remove('is-invalid');
            }
        });
    }

    if (password2) {
        password2.addEventListener('input', function () {
            if (password1.value && this.value === password1.value) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    }

    if (registerForm && submitBtn) {
        registerForm.addEventListener('submit', function (evt) {
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦æœ‰æ•ˆ
            if (username.classList.contains('is-invalid')) {
                evt.preventDefault();
                username.focus();
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²éªŒè¯
            if (!username.classList.contains('is-valid') && username.value.length >= 3) {
                evt.preventDefault();
                usernameTip.textContent = 'è¯·ç­‰å¾…ç”¨æˆ·åéªŒè¯å®Œæˆ';
                usernameTip.style.color = '#f59e0b';
                username.focus();
                return;
            }

            if (password1.value !== password2.value) {
                evt.preventDefault();
                password2.classList.add('is-invalid');
                password2.focus();
                return;
            }
            if (!registerForm.reportValidity()) {
                evt.preventDefault();
                return;
            }
            submitBtn.classList.add('is-loading');
            submitBtn.setAttribute('aria-busy', 'true');
            submitBtn.querySelector('.form-button__label').textContent = 'æäº¤ä¸­â€¦';
        });
    }
})();
</script>
{% endblock %}
