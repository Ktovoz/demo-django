{% extends 'demo/base.html' %}
{% load static %}

{% block title %}用户注册{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/register.css' %}"/>
{% endblock %}

{% block content %}
<section class="auth-wrapper auth-wrapper--register">
    <div class="auth-grid">
        <div class="auth-card" id="registerFormContainer">
        <div class="auth-card__header">
            <h2>创建账户</h2>
            <p>填写以下信息以加入 Django Hub</p>
        </div>

        {% if messages %}
        <div class="auth-alert auth-alert--error" role="alert">
            <i class="material-icons" aria-hidden="true">error_outline</i>
            <div>
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <form method="post" class="auth-form" id="registerForm" novalidate>
            {% csrf_token %}

            <div class="form-field">
                <input id="username" name="username" type="text" placeholder=" " required autocomplete="username">
                <label for="username">用户名</label>
                <small class="form-tip" id="usernameTip">支持 3-20 个字符，可包含字母、数字与下划线</small>
            </div>

            <div class="form-field form-field--with-meter">
                <input id="password1" name="password1" type="password" placeholder=" " required autocomplete="new-password">
                <label for="password1">密码</label>
                <div class="form-meter" aria-hidden="true">
                    <div class="form-meter__bar" id="passwordStrengthBar"></div>
                </div>
                <small class="form-tip" id="passwordStrengthText">请输入至少 8 位的安全密码</small>
            </div>

            <div class="form-field">
                <input id="password2" name="password2" type="password" placeholder=" " required autocomplete="new-password">
                <label for="password2">确认密码</label>
                <small class="form-tip">再次输入密码，确保两次输入一致</small>
            </div>

            <div class="form-extras">
                <label class="form-checkbox">
                    <input type="checkbox" id="agreement" required>
                    <span class="form-checkbox__decor" aria-hidden="true">
                        <i class="material-icons">check</i>
                    </span>
                    <span class="form-checkbox__label">我已阅读并同意 <a href="#" class="form-link">使用条款</a> 与 <a href="#" class="form-link">隐私政策</a></span>
                </label>
            </div>

            <button class="form-button" type="submit" id="registerSubmit">
                <span class="form-button__label">立即注册</span>
                <i class="material-icons" aria-hidden="true">person_add</i>
            </button>
        </form>

        <div class="auth-footer">
            <span>已经拥有账户？</span>
            <a href="{% url 'demo:login' %}">直接登录</a>
            </div>
    </div>

        <div class="auth-hero">
            <div class="auth-hero__card">
                <div class="auth-hero__badge">🚀 欢迎加入</div>
                <h1 class="auth-hero__title">创建专属的 Django Hub 协作空间</h1>
                <p class="auth-hero__subtitle">为团队成员规划角色、权限与流程，从注册这一刻开始高效协同。强大的权限管理系统让团队协作更安全、更高效。</p>
                <ul class="auth-hero__list">
                    <li><i class="material-icons">people_alt</i><span><strong>多角色分层</strong> - 精细化的权限边界，让团队管理更清晰</span></li>
                    <li><i class="material-icons">rule</i><span><strong>策略管控</strong> - 细粒度的权限策略，保障关键数据安全</span></li>
                    <li><i class="material-icons">insights</i><span><strong>实时审计</strong> - 完整的操作日志，掌握每一次重要变更</span></li>
                    <li><i class="material-icons">security</i><span><strong>安全可靠</strong> - 企业级安全防护，数据加密传输存储</span></li>
                </ul>
                <div class="auth-hero__stats">
                    <div class="stat-item">
                        <div class="stat-number">99.9%</div>
                        <div class="stat-label">服务可用性</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">256位</div>
                        <div class="stat-label">加密强度</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">24/7</div>
                        <div class="stat-label">监控支持</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
(function () {
    const username = document.getElementById('username');
    const usernameTip = document.getElementById('usernameTip');
    const password1 = document.getElementById('password1');
    const password2 = document.getElementById('password2');
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    const registerForm = document.getElementById('registerForm');
    const submitBtn = document.getElementById('registerSubmit');
    let usernameCheckTimeout;

    function checkUsername(username) {
        clearTimeout(usernameCheckTimeout);
        usernameCheckTimeout = setTimeout(() => {
            if (username.length < 3) {
                usernameTip.textContent = '支持 3-20 个字符，可包含字母、数字与下划线';
                usernameTip.style.color = 'var(--auth-text-secondary)';
                username.classList.remove('is-valid', 'is-invalid');
                return;
            }

            fetch(`{% url 'demo:check_username' %}?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        usernameTip.textContent = data.message;
                        usernameTip.style.color = '#34d399';
                        username.classList.add('is-valid');
                        username.classList.remove('is-invalid');
                    } else {
                        usernameTip.textContent = data.message;
                        usernameTip.style.color = '#f87171';
                        username.classList.add('is-invalid');
                        username.classList.remove('is-valid');
                    }
                })
                .catch(error => {
                    console.error('用户名验证失败:', error);
                    usernameTip.textContent = '验证服务暂时不可用，请稍后重试';
                    usernameTip.style.color = '#f59e0b';
                });
        }, 500);
    }

    function updateStrengthIndicator(value) {
        let strength = 0;
        if (value.length >= 8) strength += 25;
        if (/[A-Z]/.test(value)) strength += 25;
        if (/[0-9]/.test(value)) strength += 25;
        if (/[^A-Za-z0-9]/.test(value)) strength += 25;

        strengthBar.style.width = strength + '%';
        strengthBar.className = 'form-meter__bar';

        if (!value.length) {
            strengthText.textContent = '请输入至少 8 位的安全密码';
            return;
        }

        if (strength < 50) {
            strengthBar.classList.add('is-weak');
            strengthText.textContent = '密码强度：弱 – 建议包含大小写字母与符号';
        } else if (strength < 75) {
            strengthBar.classList.add('is-medium');
            strengthText.textContent = '密码强度：中 – 再添加一些符号会更安全';
        } else {
            strengthBar.classList.add('is-strong');
            strengthText.textContent = '密码强度：强';
        }
    }

    if (username) {
        username.addEventListener('input', function () {
            checkUsername(this.value);
        });
    }

    if (password1) {
        password1.addEventListener('input', function () {
            updateStrengthIndicator(this.value);
            if (password2.value && password2.value !== this.value) {
                password2.classList.add('is-invalid');
            } else {
                password2.classList.remove('is-invalid');
            }
        });
    }

    if (password2) {
        password2.addEventListener('input', function () {
            if (password1.value && this.value === password1.value) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    }

    if (registerForm && submitBtn) {
        registerForm.addEventListener('submit', function (evt) {
            // 检查用户名是否有效
            if (username.classList.contains('is-invalid')) {
                evt.preventDefault();
                username.focus();
                return;
            }

            // 检查用户名是否已验证
            if (!username.classList.contains('is-valid') && username.value.length >= 3) {
                evt.preventDefault();
                usernameTip.textContent = '请等待用户名验证完成';
                usernameTip.style.color = '#f59e0b';
                username.focus();
                return;
            }

            if (password1.value !== password2.value) {
                evt.preventDefault();
                password2.classList.add('is-invalid');
                password2.focus();
                return;
            }
            if (!registerForm.reportValidity()) {
                evt.preventDefault();
                return;
            }
            submitBtn.classList.add('is-loading');
            submitBtn.setAttribute('aria-busy', 'true');
            submitBtn.querySelector('.form-button__label').textContent = '提交中…';
        });
    }
})();
</script>
{% endblock %}
