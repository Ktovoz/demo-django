{% extends 'demo/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/user-management.css' %}">
{% endblock %}

{% block content %}
    <!-- 移动端菜单按钮 -->
    <div class="mobile-menu-btn hide-on-large-only" id="menuToggle">
        <i class="material-icons">menu</i>
    </div>
    
    <!-- 侧边栏 -->
    <nav class="sidebar" id="sideNav">
        <div class="user-info">
            <div class="row mb-0" style="margin-bottom: 0;">
                <div class="col s8" style="padding: 0 0.5rem;">
                    <h6 class="white-text" style="margin: 0 0 8px 0; font-size: 1.2rem; line-height: 1.2;">{{ user.username }}</h6>
                    <div class="white-text" style="opacity: 0.8; font-size: 0.9rem; margin-bottom: 6px; line-height: 1.2;">{{ user.groups.all.0.name|default:"无用户组" }}</div>
                    <div class="user-login-time white-text" style="opacity: 0.6; font-size: 0.8rem; line-height: 1.2; display: flex; align-items: center;">
                        <i class="material-icons tiny" style="font-size: 14px; margin-right: 4px;">access_time</i>
                        <span>最近登录: {{ user.last_login|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
                <div class="col s4" style="padding: 0 0.5rem; text-align: right;">
                    <form method="post" action="{% url 'demo:logout' %}" style="margin: 0;">
                        {% csrf_token %}
                        <button class="btn-floating waves-effect waves-light" style="background: transparent; box-shadow: none;">
                            <i class="material-icons">exit_to_app</i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <ul class="collection with-header">
            <li class="collection-header"><h5>系统菜单</h5></li>
            <li class="collection-item waves-effect" onclick="showUserList(this)" data-view="userListView">
                <i class="material-icons">people</i>用户列表
            </li>
            <li class="collection-item waves-effect" onclick="showGroupList(this)" data-view="groupListView">
                <i class="material-icons">group_work</i>用户组管理
            </li>
        </ul>
    </nav>

    <main>
        <!-- 操作提示 -->
        <div class="action-hint" id="actionHint">
            <span class="close" onclick="closeHint()">×</span>
            <p id="hintContent"></p>
        </div>

        <!-- 用户列表视图 -->
        <div class="content-card" id="userListView">
            <div class="row">
                <div class="col s6">
                    <h4 class="header">用户列表</h4>
                </div>
                <div class="col s6 right-align">
                    {% if perms.auth.add_user %}
                    <a class="waves-effect waves-light btn" onclick="showCreateUserModal()">
                        <i class="material-icons left">person_add</i>新增用户
                    </a>
                    {% endif %}
                    <a class="waves-effect waves-light btn" onclick="refreshUserList()">
                        <i class="material-icons left">refresh</i>刷新
                    </a>
                </div>
            </div>

            <table class="highlight responsive-table">
                <thead>
                    <tr>
                        <th>用户名</th>
                        <th>邮箱</th>
                        <th>用户组</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    {% for user in users %}
                    <tr data-user-id="{{ user.id }}">
                        <td>{{ user.username }}</td>
                        <td>{{ user.email|default:"-" }}</td>
                        <td>{{ user.groups.all.0.name|default:"无" }}</td>
                        <td>
                            {% if user.is_active %}
                            <span class="badge active">正常</span>
                            {% else %}
                            <span class="badge inactive">禁用</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if perms.auth.change_user %}
                            <a class="waves-effect waves-light btn-small" onclick="showEditUserModal({{ user.id|escapejs }})">
                                <i class="material-icons">edit</i>
                            </a>
                            <a class="waves-effect waves-light btn-small orange" onclick="showChangePasswordModal({{ user.id|escapejs }})">
                                <i class="material-icons">lock</i>
                            </a>
                            {% endif %}
                            {% if perms.auth.delete_user and user.id != request.user.id %}
                            <a class="waves-effect waves-light btn-small red" onclick="deleteUser({{ user.id|escapejs }})">
                                <i class="material-icons">delete</i>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 用户组列表视图 -->
        <div class="content-card d-none" id="groupListView">
            <div class="row">
                <div class="col s12">
                    <h4 class="header">用户组管理</h4>
                </div>
            </div>

            <table class="highlight responsive-table">
                <thead>
                    <tr>
                        <th>组名</th>
                        <th>成员数量</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="groupTableBody">
                    {% for group in groups %}
                    <tr>
                        <td>{{ group.name }}</td>
                        <td>{{ group.user_set.count }}</td>
                        <td>
                            <a class="waves-effect waves-light btn-small" onclick="showGroupMembers({{ group.id }})">
                                <i class="material-icons left">group</i>查看成员
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- 用户模态框 -->
    <div id="userModal" class="modal">
        <div class="modal-header">
            <h5 id="userModalTitle">编辑用户</h5>
        </div>
        <div class="modal-content">
            <form id="userForm">
                {% csrf_token %}
                <input type="hidden" id="userId">
                <div class="input-field">
                    <input type="text" id="username" required>
                    <label for="username">用户名</label>
                </div>
                <div class="input-field">
                    <input type="email" id="email">
                    <label for="email">邮箱</label>
                </div>
                <div class="input-field" id="passwordGroup">
                    <input type="password" id="password">
                    <label for="password">密码</label>
                    <span class="helper-text">创建用户时必填，编辑用户时留空表示不修改密码</span>
                </div>
                <div class="input-field">
                    <select id="userGroup">
                        <option value="">无</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                    <label>用户组</label>
                </div>
                <div class="switch">
                    <label>
                        禁用
                        <input type="checkbox" id="isActive" checked>
                        <span class="lever"></span>
                        正常
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a class="modal-close waves-effect waves-light btn-flat">取消</a>
            <a class="waves-effect waves-light btn" onclick="saveUser()">保存</a>
        </div>
    </div>

    <!-- 密码模态框 -->
    <div id="passwordModal" class="modal">
        <div class="modal-header">
            <h5 id="passwordModalTitle">修改密码</h5>
        </div>
        <div class="modal-content">
            <form id="passwordForm">
                {% csrf_token %}
                <input type="hidden" id="passwordUserId">
                {% if not user.is_superuser %}
                <div class="input-field" id="oldPasswordGroup">
                    <input type="password" id="oldPassword" required>
                    <label for="oldPassword">旧密码</label>
                </div>
                {% endif %}
                <div class="input-field">
                    <input type="password" id="newPassword" required>
                    <label for="newPassword">新密码</label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a class="modal-close waves-effect waves-light btn-flat">取消</a>
            <a class="waves-effect waves-light btn" onclick="savePassword()">保存</a>
        </div>
    </div>

    <!-- 用户组成员模态框 -->
    <div id="groupMembersModal" class="modal modal-fixed-footer">
        <div class="modal-header">
            <h5 id="groupMembersModalTitle">用户组成员</h5>
        </div>
        <div class="modal-content">
            <table class="highlight">
                <thead>
                    <tr>
                        <th>用户名</th>
                        <th>邮箱</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="groupMembersTableBody">
                </tbody>
            </table>

            {% if perms.auth.change_user %}
            <div class="row">
                <div class="input-field col s12">
                    <select id="userToAdd">
                        <option value="">选择用户...</option>
                    </select>
                    <label>添加用户到组</label>
                </div>
                <div class="col s12">
                    <a class="waves-effect waves-light btn" onclick="addUserToGroup()">
                        <i class="material-icons left">person_add</i>添加
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="modal-footer">
            <a class="modal-close waves-effect waves-light">取消</a>
            <a class="waves-effect waves-light btn save-btn" onclick="saveUser()">保存</a>
        </div>
    </div>
</body>

<script>
    // 设置全局变量
    currentUserId = {{ request.user.id }};
    currentUserGroup = '{{ user.groups.all.0.name|escapejs }}';
    currentUserName = '{{ user.username|escapejs }}';
    hasChangeUserPerm = {% if perms.auth.change_user %}true{% else %}false{% endif %};
    hasDeleteUserPerm = {% if perms.auth.delete_user %}true{% else %}false{% endif %};
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/user-management.js' %}"></script>
{% endblock %}