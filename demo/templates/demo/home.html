{% extends 'demo/base.html' %}
{% load static %}

{% block title %}{{ title|default:"User Management Console" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user-management.css' %}">
{% endblock %}

{% block content %}
<div class="layout-shell">
    <button class="mobile-menu-btn hide-on-large-only" id="menuToggle" type="button" aria-label="Open navigation">
        <i class="material-icons">menu</i>
    </button>

    <nav class="sidebar" id="sideNav" aria-label="Primary navigation">
        <div class="sidebar-brand glass-card">
            <div class="brand-icon">
                <i class="material-icons">dashboard_customize</i>
            </div>
            <div class="brand-copy">
                <span class="brand-title">Control Center</span>
                <span class="brand-subtitle">User Console</span>
            </div>
        </div>

        <div class="user-info glass-card">
            <div class="user-identity">
                <div class="avatar-badge">
                    <span>{{ user.username|first|upper }}</span>
                </div>
                <div class="identity-meta">
                    <h6 class="user-name">{{ user.get_full_name|default:user.username }}</h6>
                    <div class="user-group">{{ user.groups.all.0.name|default:"No group assigned" }}</div>
                    <div class="user-login-time">
                        <i class="material-icons tiny">access_time</i>
                        <span>
                            Last sign in:
                            {% if user.last_login %}
                                {{ user.last_login|date:"Y-m-d H:i" }}
                            {% else %}
                                Not recorded
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            <form method="post" action="{% url 'demo:logout' %}" class="logout-form">
                {% csrf_token %}
                <button class="btn-floating waves-effect waves-light tooltipped"
                        data-tooltip="Sign out"
                        aria-label="Sign out"
                        type="submit">
                    <i class="material-icons">exit_to_app</i>
                </button>
            </form>
        </div>

        <div class="sidebar-menu">
            <h6 class="menu-title">Workspace</h6>
            <ul class="collection menu-collection" role="tablist" aria-label="Workspace views">
                <li class="collection-item is-active">
                    <button type="button"
                            class="menu-item-trigger waves-effect active"
                            data-action="switch-view"
                            data-target="userListView"
                            aria-controls="userListView"
                            aria-pressed="true">
                        <span class="menu-item-icon">
                            <i class="material-icons">people</i>
                        </span>
                        <span class="menu-item-copy">
                            <span>User directory</span>
                            <small>Browse and manage every account</small>
                        </span>
                        <i class="material-icons trailing">chevron_right</i>
                    </button>
                </li>
                <li class="collection-item">
                    <button type="button"
                            class="menu-item-trigger waves-effect"
                            data-action="switch-view"
                            data-target="groupListView"
                            aria-controls="groupListView"
                            aria-pressed="false">
                        <span class="menu-item-icon">
                            <i class="material-icons">group_work</i>
                        </span>
                        <span class="menu-item-copy">
                            <span>Group roles</span>
                            <small>Maintain permissions and membership</small>
                        </span>
                        <i class="material-icons trailing">chevron_right</i>
                    </button>
                </li>
            </ul>
        </div>

        <div class="sidebar-tip glass-card">
            <h6>Pro tip</h6>
            <p>Use the quick actions and search tools on the right to keep accounts in sync faster.</p>
        </div>
    </nav>

    <main class="main-content" role="main">
        <section class="welcome-panel glass-card">
            <div class="welcome-primary">
                <span class="panel-badge">
                    <i class="material-icons tiny">verified_user</i>
                    User Management Hub
                </span>
                <h2 class="panel-title">Welcome back, {{ user.get_full_name|default:user.username }}!</h2>
                <p class="panel-copy">Review account status, group assignments, and permissions in one streamlined workspace.</p>
                <div class="metric-row">
                    <div class="metric-pill">
                        <span class="metric-label">Total users</span>
                        <span class="metric-value">{{ user_count }}</span>
                    </div>
                    <div class="metric-pill">
                        <span class="metric-label">Groups</span>
                        <span class="metric-value">{{ group_count }}</span>
                    </div>
                    <div class="metric-pill">
                        <span class="metric-label">Your last login</span>
                        <span class="metric-value">
                            {% if request.user.last_login %}
                                {{ request.user.last_login|date:"m-d H:i" }}
                            {% else %}
                                &ndash;
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            <div class="welcome-secondary">
                <div class="health-card">
                    <div class="health-headline">
                        <span class="health-title">Checklist</span>
                        <span class="health-status">
                            <i class="material-icons tiny">circle</i>
                            Secure
                        </span>
                    </div>
                    <ul class="health-list">
                        <li><i class="material-icons tiny">check_circle</i> Audit role assignments every month</li>
                        <li><i class="material-icons tiny">check_circle</i> Rotate passwords for privileged accounts</li>
                        <li><i class="material-icons tiny">check_circle</i> Monitor login anomalies</li>
                    </ul>
                </div>
                <div class="illustration-card" aria-hidden="true">
                    <div class="glow glow-1"></div>
                    <div class="glow glow-2"></div>
                    <span class="illustration-copy">Stay aligned &amp; compliant</span>
                </div>
            </div>
        </section>

        <section class="toolbar glass-card" id="commandToolbar">
            <div class="toolbar-section view-controls" role="tablist">
                <button type="button" class="view-toggle active" id="userViewTab" role="tab" data-view="userListView" aria-controls="userListView" aria-selected="true">
                    <i class="material-icons tiny">table_rows</i>
                    Users
                </button>
                <button type="button" class="view-toggle" id="groupViewTab" role="tab" data-view="groupListView" aria-controls="groupListView" aria-selected="false">
                    <i class="material-icons tiny">category</i>
                    Groups
                </button>
            </div>
            <div class="toolbar-section search-controls">
                <label class="search-field" for="userSearchInput">
                    <i class="material-icons">search</i>
                    <input type="text" id="userSearchInput" placeholder="Search by username or email" aria-label="Search user list">
                </label>
            </div>
            <div class="toolbar-section action-controls">
                {% if perms.auth.add_group %}
                <button type="button" class="btn chip-btn" data-action="switch-view" data-target="groupListView" aria-controls="groupListView">
                    <i class="material-icons left">shield</i>Manage groups
                </button>
                {% endif %}
                {% if perms.auth.add_user %}
                <button type="button" class="btn accent-btn" data-action="open-create-user">
                    <i class="material-icons left">person_add</i>New user
                </button>
                {% endif %}
                <button type="button" class="icon-btn" data-action="refresh-users" aria-label="Refresh data">
                    <i class="material-icons">refresh</i>
                </button>
            </div>
        </section>

        <section class="summary-grid">
            <article class="summary-card glass-card">
                <div class="summary-icon primary"><i class="material-icons">groups</i></div>
                <div class="summary-copy">
                    <span class="summary-title">Active accounts</span>
                    <span class="summary-value">{{ active_user_count }}</span>
                    <p class="summary-note">Monitor sign-ins and disable unused accounts promptly.</p>
                </div>
            </article>
            <article class="summary-card glass-card">
                <div class="summary-icon accent"><i class="material-icons">account_tree</i></div>
                <div class="summary-copy">
                    <span class="summary-title">Permission sets</span>
                    <span class="summary-value">{{ group_count }}</span>
                    <p class="summary-note">Keep access scoped to the minimum required roles.</p>
                </div>
            </article>
            <article class="summary-card glass-card">
                <div class="summary-icon warning"><i class="material-icons">schedule</i></div>
                <div class="summary-copy">
                    <span class="summary-title">Latest login</span>
                    <span class="summary-value">
                        {% if user.last_login %}
                            {{ user.last_login|date:"m-d H:i" }}
                        {% else %}
                            Not recorded
                        {% endif %}
                    </span>
                    <p class="summary-note">Encourage MFA for privileged operators.</p>
                </div>
            </article>
        </section>

        <div class="action-hint glass-card" id="actionHint" role="status" aria-live="polite">
            <button class="close" type="button" data-action="dismiss-hint" aria-label="Dismiss hint">&times;</button>
            <p id="hintContent"></p>
        </div>

        <section class="data-panel glass-card" id="userListView" role="tabpanel" aria-labelledby="userViewTab" aria-hidden="false">
            <header class="panel-header">
                <div>
                    <h3 class="panel-heading">User directory</h3>
                    <p class="panel-subtitle">Filter by username, email address, or group membership.</p>
                </div>
                <div class="panel-actions">
                    {% if perms.auth.add_user %}
                    <button type="button" class="btn primary-btn" data-action="open-create-user">
                        <i class="material-icons left">person_add</i>Add user
                    </button>
                    {% endif %}
                    <button type="button" class="btn ghost-btn" data-action="refresh-users">
                        <i class="material-icons left">refresh</i>Refresh
                    </button>
                </div>
            </header>

            <table class="highlight responsive-table elevated-table" id="userTable">
                <thead>
                    <tr>
                        <th scope="col">Username</th>
                        <th scope="col">Email</th>
                        <th scope="col">Group</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="align-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    {% for member in users %}
                    <tr data-user-id="{{ member.id }}">
                        <td>
                            <div class="table-cell-primary">
                                <span class="cell-title">{{ member.username }}</span>
                                <span class="cell-subtitle">
                                    {% if member.get_full_name %}
                                        {{ member.get_full_name }}
                                    {% else %}
                                        Name not provided
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                        <td>{{ member.email|default:"-" }}</td>
                        <td>{{ member.groups.all.0.name|default:"Unassigned" }}</td>
                        <td>
                            {% if member.is_active %}
                            <span class="badge active">Active</span>
                            {% else %}
                            <span class="badge inactive">Suspended</span>
                            {% endif %}
                        </td>
                        <td class="align-right">
                            <div class="table-actions" role="group" aria-label="Row actions">
                                {% if perms.auth.change_user %}
                                <button type="button" class="icon-btn" data-action="edit-user" data-user-id="{{ member.id }}" title="Edit user">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button type="button" class="icon-btn warning" data-action="reset-password" data-user-id="{{ member.id }}" title="Reset password">
                                    <i class="material-icons">lock</i>
                                </button>
                                {% endif %}
                                {% if perms.auth.delete_user and member.id != request.user.id %}
                                <button type="button" class="icon-btn danger" data-action="delete-user" data-user-id="{{ member.id }}" title="Delete user">
                                    <i class="material-icons">delete</i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="empty-row">
                        <td colspan="5">No user accounts found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section class="data-panel glass-card hidden" id="groupListView" role="tabpanel" aria-labelledby="groupViewTab" aria-hidden="true">
            <header class="panel-header">
                <div>
                    <h3 class="panel-heading">Group roles</h3>
                    <p class="panel-subtitle">Assign responsibilities and guardrails for every team.</p>
                </div>
            </header>

            <table class="highlight responsive-table elevated-table">
                <thead>
                    <tr>
                        <th scope="col">Group name</th>
                        <th scope="col">Members</th>
                        <th scope="col" class="align-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="groupTableBody">
                    {% for role in groups %}
                    <tr>
                        <td>
                            <div class="table-cell-primary">
                                <span class="cell-title">{{ role.name }}</span>
                                <span class="cell-subtitle">ID: {{ role.id }}</span>
                            </div>
                        </td>
                        <td>{{ role.member_count }}</td>
                        <td class="align-right">
                            <button type="button" class="btn ghost-btn" data-action="show-group-members" data-group-id="{{ role.id }}">
                                <i class="material-icons left">group</i>View members
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="empty-row">
                        <td colspan="3">No groups available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </main>
</div>

<div id="userModal" class="modal glass-modal" aria-hidden="true" aria-labelledby="userModalTitle">
    <div class="modal-header">
        <h5 id="userModalTitle">Edit user</h5>
    </div>
    <div class="modal-content">
        <form id="userForm">
            {% csrf_token %}
            <input type="hidden" id="userId">
            <div class="input-field">
                <input type="text" id="username" required data-initial-focus="true">
                <label for="username">Username</label>
                <span class="helper-text">Provide a unique username.</span>
            </div>
            <div class="input-field">
                <input type="email" id="email">
                <label for="email">Email</label>
                <span class="helper-text">Optional but recommended for notifications.</span>
            </div>
            <div class="input-field" id="passwordGroup">
                <input type="password" id="password">
                <label for="password">Password</label>
                <span class="helper-text">Required when creating a user. Leave blank to keep the current password.</span>
            </div>
            <div class="input-field">
                <select id="userGroup">
                    <option value="">Select a group</option>
                    {% for role in groups %}
                    <option value="{{ role.id }}">{{ role.name }}</option>
                    {% endfor %}
                </select>
                <label>Group</label>
            </div>
            <div class="switch">
                <label>
                    Suspend
                    <input type="checkbox" id="isActive" checked>
                    <span class="lever"></span>
                    Active
                </label>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="modal-close waves-effect waves-light btn-flat" data-modal-close="true">Cancel</button>
        <button type="button" class="waves-effect waves-light btn" data-action="save-user">Save</button>
    </div>
</div>

<div id="passwordModal" class="modal glass-modal" aria-hidden="true" aria-labelledby="passwordModalTitle">
    <div class="modal-header">
        <h5 id="passwordModalTitle">Reset password</h5>
    </div>
    <div class="modal-content">
        <form id="passwordForm">
            {% csrf_token %}
            <input type="hidden" id="passwordUserId">
            {% if not user.is_superuser %}
            <div class="input-field" id="oldPasswordGroup">
                <input type="password" id="oldPassword" required>
                <label for="oldPassword">Current password</label>
                <span class="helper-text">Needed when you reset your own password.</span>
            </div>
            {% endif %}
            <div class="input-field">
                <input type="password" id="newPassword" required>
                <label for="newPassword">New password</label>
                <span class="helper-text">Use a mix of upper and lower case letters, numbers, and symbols.</span>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="modal-close waves-effect waves-light btn-flat" data-modal-close="true">Cancel</button>
        <button type="button" class="waves-effect waves-light btn" data-action="save-password">Save</button>
    </div>
</div>

<div id="groupMembersModal" class="modal modal-fixed-footer glass-modal" aria-hidden="true" aria-labelledby="groupMembersModalTitle">
    <div class="modal-header">
        <h5 id="groupMembersModalTitle">Group members</h5>
    </div>
    <div class="modal-content">
        <table class="highlight elevated-table">
            <thead>
                <tr>
                    <th scope="col">Username</th>
                    <th scope="col">Email</th>
                    <th scope="col">Status</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody id="groupMembersTableBody"></tbody>
        </table>

        {% if perms.auth.change_user %}
        <div class="row compact-row">
            <div class="input-field col s12">
                <select id="userToAdd">
                    <option value="">Select a user...</option>
                </select>
                <label>Add user to group</label>
            </div>
            <div class="col s12 align-right">
                <button type="button" class="waves-effect waves-light btn" data-action="add-user-to-group">
                    <i class="material-icons left">person_add</i>Add
                </button>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="modal-footer">
        <button type="button" class="modal-close waves-effect waves-light btn-flat" data-modal-close="true">Close</button>
        <button type="button" class="waves-effect waves-light btn" data-action="save-group-members">Save</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.dashboardState = JSON.parse('{{ dashboard_state_json|escapejs }}');
</script>
<script src="{% static 'js/user-management.js' %}"></script>
{% endblock %}
